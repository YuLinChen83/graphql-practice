# Migration `20200806175823-v1`

This migration has been generated by Tiffany at 8/6/2020, 5:58:23 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE `singple`.`Role` (
`id` int NOT NULL  AUTO_INCREMENT,
`name` varchar(191) NOT NULL ,
`permissionIds` varchar(191)  ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `singple`.`Permission` (
`id` int NOT NULL  AUTO_INCREMENT,
`name` varchar(191) NOT NULL ,
`remark` varchar(191)  ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `singple`.`User` (
`id` int NOT NULL  AUTO_INCREMENT,
`email` varchar(191) NOT NULL ,
`lastName` varchar(191) NOT NULL ,
`firstName` varchar(191) NOT NULL ,
`nickName` varchar(191) NOT NULL ,
`website` varchar(191)  ,
`notified` boolean NOT NULL DEFAULT false,
`activated` boolean NOT NULL DEFAULT false,
`birthday` datetime(3)  ,
`photo` varchar(191)  ,
`gender` ENUM('MALE', 'FEMALE', 'TRANSGENDER')  ,
`password` varchar(191) NOT NULL ,
`courseIds` varchar(191)  ,
`orderIds` varchar(191)  ,
`createdAt` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
`updatedAt` datetime(3)  ,
`facebookId` varchar(191)  ,
`googleId` varchar(191)  ,
`roleId` int NOT NULL ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `singple`.`Order` (
`id` int NOT NULL  AUTO_INCREMENT,
`courseId` int NOT NULL ,
`userId` int NOT NULL ,
`purchaseTime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
`status` varchar(191) NOT NULL DEFAULT '待付款',
`salesAttributedTo` int  ,
`paymentType` varchar(191) NOT NULL DEFAULT 'Paypel',
`remark` varchar(191)  ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `singple`.`LearningHistory` (
`userId` int NOT NULL ,
`courseId` int NOT NULL ,
`time` int NOT NULL ,
`note` varchar(191) NOT NULL ,
`isComplete` boolean NOT NULL ,
PRIMARY KEY (`userId`,`courseId`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `singple`.`Course` (
`id` int NOT NULL  AUTO_INCREMENT,
`typeCode` varchar(191) NOT NULL DEFAULT 'SYS',
`title` varchar(191) NOT NULL ,
`content` varchar(191) NOT NULL ,
`price` int NOT NULL ,
`specialPrice` int  ,
`vedioUrl` varchar(191)  ,
`totalTime` int  ,
`remark` varchar(191)  ,
`publishTime` datetime(3)  ,
`teacherIds` varchar(191)  ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `singple`.`CourseAnnoucement` (
`id` int NOT NULL  AUTO_INCREMENT,
`courseId` int NOT NULL ,
`title` varchar(191) NOT NULL ,
`content` varchar(191)  ,
`createdAt` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `singple`.`SystematicCourse` (
`courseId` int NOT NULL ,
`typeName` varchar(191) NOT NULL ,
`chapterUnit` varchar(191) NOT NULL ,
`title` varchar(191) NOT NULL ,
`content` varchar(191)  ,
`attachmentUrl` varchar(191)  ,
`vedioUrl` varchar(191)  ,
`remark` varchar(191)  ,
`createdAt` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
`updatedAt` datetime(3)  ,
PRIMARY KEY (`courseId`,`chapterUnit`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `singple`.`OneToOneCourseReservation` (
`id` int NOT NULL  AUTO_INCREMENT,
`courseId` int NOT NULL ,
`userId` int NOT NULL ,
`startTime` datetime(3)  ,
`endTime` datetime(3)  ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `singple`.`CourseComment` (
`id` int NOT NULL  AUTO_INCREMENT,
`courseId` int NOT NULL ,
`chapterName` varchar(191) NOT NULL ,
`unitName` varchar(191) NOT NULL ,
`userId` int NOT NULL ,
`content` varchar(191) NOT NULL ,
`createdAt` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
`updatedAt` datetime(3)  ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `singple`.`CourseCommentReply` (
`id` int NOT NULL ,
`userId` int NOT NULL ,
`content` varchar(191) NOT NULL ,
`createdAt` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
`updatedAt` datetime(3)  ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE UNIQUE INDEX `Role.name` ON `singple`.`Role`(`name`)

CREATE UNIQUE INDEX `Permission.name` ON `singple`.`Permission`(`name`)

CREATE UNIQUE INDEX `User.email` ON `singple`.`User`(`email`)

ALTER TABLE `singple`.`User` ADD FOREIGN KEY (`roleId`) REFERENCES `singple`.`Role`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `singple`.`Order` ADD FOREIGN KEY (`courseId`) REFERENCES `singple`.`Course`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `singple`.`Order` ADD FOREIGN KEY (`userId`) REFERENCES `singple`.`User`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `singple`.`LearningHistory` ADD FOREIGN KEY (`userId`) REFERENCES `singple`.`User`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `singple`.`LearningHistory` ADD FOREIGN KEY (`courseId`) REFERENCES `singple`.`Course`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `singple`.`CourseAnnoucement` ADD FOREIGN KEY (`courseId`) REFERENCES `singple`.`Course`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `singple`.`SystematicCourse` ADD FOREIGN KEY (`courseId`) REFERENCES `singple`.`Course`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `singple`.`OneToOneCourseReservation` ADD FOREIGN KEY (`courseId`) REFERENCES `singple`.`Course`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `singple`.`OneToOneCourseReservation` ADD FOREIGN KEY (`userId`) REFERENCES `singple`.`User`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `singple`.`CourseComment` ADD FOREIGN KEY (`courseId`) REFERENCES `singple`.`Course`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `singple`.`CourseComment` ADD FOREIGN KEY (`userId`) REFERENCES `singple`.`User`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `singple`.`CourseCommentReply` ADD FOREIGN KEY (`id`) REFERENCES `singple`.`CourseComment`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `singple`.`CourseCommentReply` ADD FOREIGN KEY (`userId`) REFERENCES `singple`.`User`(`id`) ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20200806175823-v1
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,157 @@
+generator client {
+  provider = "prisma-client-js"
+}
+
+datasource mysql {
+  provider = "mysql"
+  url = "***"
+}
+
+// 定義角色&其擁有權限
+model Role {
+  id             Int              @default(autoincrement()) @id
+  name           String           @unique   //SUPERADMIN, ADMIN(TEACHER), USER(STUDENT)
+  permissionIds  String?          //權限：以,分割permissionId
+}
+
+// 定義行為操作權限
+model Permission {
+  id             Int              @default(autoincrement()) @id
+  name           String           @unique
+  remark         String?
+}
+
+// 使用者(roleId區分SuperAdmin/Teacher/Student)
+model User {
+  id             Int              @default(autoincrement()) @id
+  email          String           @unique
+  lastName       String
+  firstName       String
+  nickName       String
+  website        String?
+  notified        Boolean          @default(false)
+  activated      Boolean          @default(false)
+  birthday       DateTime?
+  photo          String?
+  gender         Gender?
+  password       String
+  courseIds      String?         //購買課程：以,分割courseId
+  orderIds       String?         //訂單記錄：以,分割orderIds
+  createdAt      DateTime         @default(now())
+  updatedAt      DateTime?        @updatedAt
+  facebookId     String?
+  googleId       String?
+  roleId         Int
+  role           Role             @relation(fields: [roleId], references: [id])
+}
+
+// 所有訂單列表(後台為主)
+model Order {
+  id             Int              @default(autoincrement()) @id
+  courseId       Int
+  course         Course           @relation(fields: [courseId], references: [id])
+  userId         Int
+  user           User             @relation(fields: [userId], references: [id])
+  purchaseTime   DateTime         @default(now())
+  status         String           @default("待付款")  //待確認,待發貨,待收貨,已取消,已退款
+  salesAttributedTo Int?    //業績歸屬?(可以認領)
+  paymentType    String           @default("Paypel") //
+  remark         String?
+}
+
+// 學習紀錄
+model LearningHistory {
+  userId         Int
+  user           User             @relation(fields: [userId], references: [id])
+  courseId       Int
+  course         Course           @relation(fields: [courseId], references: [id])
+  time           Int      //已觀看時間
+  note           String   //重點筆記
+  isComplete     Boolean  //是否完成
+
+  @@id([userId, courseId])
+}
+
+// 課程總檔
+model Course {
+  id             Int              @default(autoincrement()) @id
+  typeCode       String           @default("SYS") //SYS:系統化, OTO: 一對一, OL:線上(後台收入類型用)
+  title          String
+  content        String
+  price          Int
+  specialPrice   Int?
+  vedioUrl       String?
+  totalTime      Int?   //系統化課程總時間
+  remark         String?
+  publishTime    DateTime?
+  teacherIds     String?    //多老師則,分隔userId
+}
+
+// 課程公告
+model CourseAnnoucement {
+  id             Int              @default(autoincrement()) @id
+  courseId       Int
+  course         Course           @relation(fields: [courseId], references: [id])
+  title          String
+  content        String?
+  createdAt      DateTime         @default(now())
+}
+
+// 系統化課程
+model SystematicCourse {
+  courseId       Int
+  course         Course           @relation(fields: [courseId], references: [id])
+  typeName       String     //CHAPTER, UNIT, HW
+  chapterUnit    String     //1,1-1,1-2...
+  title          String
+  content        String?
+  attachmentUrl  String?    //附件url
+  vedioUrl       String?
+  remark         String?
+  createdAt      DateTime         @default(now())
+  updatedAt      DateTime?        @updatedAt
+
+  @@id([courseId, chapterUnit])
+}
+
+// 一對一課程預約紀錄
+model OneToOneCourseReservation {
+  id             Int              @default(autoincrement()) @id
+  courseId       Int
+  course         Course           @relation(fields: [courseId], references: [id])
+  userId         Int
+  user           User             @relation(fields: [userId], references: [id])
+  startTime      DateTime?
+  endTime        DateTime?
+}
+
+// 課程公共討論區
+model CourseComment {
+  id             Int              @default(autoincrement()) @id
+  courseId       Int
+  course         Course           @relation(fields: [courseId], references: [id])
+  chapterName    String
+  unitName       String
+  userId         Int
+  author         User             @relation(fields: [userId], references: [id])
+  content        String
+  createdAt      DateTime         @default(now())
+  updatedAt      DateTime?        @updatedAt
+}
+
+// 討論區回覆
+model CourseCommentReply {
+  id             Int              @default(autoincrement()) @id
+  commentId      CourseComment    @relation(fields: [id], references: [id])
+  userId         Int
+  author         User             @relation(fields: [userId], references: [id])
+  content        String
+  createdAt      DateTime         @default(now())
+  updatedAt      DateTime?        @updatedAt
+}
+
+enum Gender {
+  MALE
+  FEMALE
+  TRANSGENDER
+}
```


